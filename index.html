<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agent Kit Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script
    src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js"
    async
  ></script>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #0c111c;
      --panel: #111827;
      --card: #0f172a;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --accent: #22d3ee;
      --border: #1f2937;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at top, rgba(34, 211, 238, 0.08), transparent 45%),
        radial-gradient(circle at 20% 30%, rgba(99, 102, 241, 0.08), transparent 30%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px;
    }

    .page {
      width: min(1200px, 100%);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 28px;
      align-items: start;
    }

    .card {
      background: rgba(15, 23, 42, 0.75);
      backdrop-filter: blur(14px);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 22px 24px;
      box-shadow: 0 20px 70px rgba(0, 0, 0, 0.35);
    }

    h1 {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 28px;
      margin: 0 0 8px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(34, 211, 238, 0.1);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 14px;
      font-size: 14px;
      font-weight: 600;
      border: 1px solid rgba(34, 211, 238, 0.25);
    }

    p {
      margin: 0;
      color: var(--muted);
      line-height: 1.6;
    }

    .list {
      list-style: none;
      padding: 0;
      margin: 14px 0 0;
      display: grid;
      gap: 8px;
    }

    .list li {
      display: grid;
      grid-template-columns: 20px 1fr;
      gap: 10px;
      align-items: start;
      color: var(--text);
      font-weight: 500;
    }

    .list span {
      color: var(--muted);
      font-weight: 400;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      font-size: 12px;
      color: var(--muted);
    }

    .status {
      margin-top: 14px;
      font-size: 14px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--muted);
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.05);
    }

    .status.ready .dot {
      background: #34d399;
    }

    .status.error .dot {
      background: #f87171;
    }

    #chatkit-embed {
      min-height: 520px;
      border-radius: 14px;
      border: 1px dashed var(--border);
      background: rgba(17, 24, 39, 0.65);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
    }

    code {
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
      background: rgba(255, 255, 255, 0.05);
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid var(--border);
      color: var(--text);
    }
  </style>
</head>
<body>
  <main class="page">
    <section class="card">
      <div class="badge">Agent Kit + ChatKit embed</div>
      <h1>
        Launch your GPT-powered agent
      </h1>
      <p>
        This page hosts a ChatKit widget wired to your Agent Builder workflow. Add your API key
        and workflow ID as Netlify environment variables to generate client secrets for the chat
        session. The frontend only receives the short-lived <code>client_secret</code>, keeping your
        server key secure.
      </p>
      <ul class="list">
        <li>
          <strong>1.</strong>
          <span>Set <code>OPENAI_API_KEY</code> and <code>WORKFLOW_ID</code> in your deployment.</span>
        </li>
        <li>
          <strong>2.</strong>
          <span>Reload this page; we create a session per visitor/device.</span>
        </li>
        <li>
          <strong>3.</strong>
          <span>Chat with your agent below using the embeddable widget.</span>
        </li>
      </ul>
      <div class="status" id="status"><span class="dot"></span><span data-status>Loading ChatKit…</span></div>
    </section>

    <section class="card">
      <div class="pill">Secure client secret fetch</div>
      <div id="chatkit-embed">Waiting for ChatKit script…</div>
    </section>
  </main>

  <script>
    const statusEl = document.querySelector("[data-status]");
    const statusWrap = document.getElementById("status");

    function setStatus(message, variant = "idle") {
      if (statusEl) statusEl.textContent = message;
      statusWrap?.classList.remove("ready", "error");
      if (variant === "ready") statusWrap?.classList.add("ready");
      if (variant === "error") statusWrap?.classList.add("error");
    }

    function getDeviceId() {
      const key = "chatkit-device-id";
      const existing = localStorage.getItem(key);
      if (existing) return existing;
      const fresh = crypto.randomUUID();
      localStorage.setItem(key, fresh);
      return fresh;
    }

    async function fetchClientSecret() {
      const response = await fetch("/api/chatkit-session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user: getDeviceId() }),
      });

      const payload = await response.json();
      if (!response.ok) {
        throw new Error(payload.error || "Unable to fetch client secret");
      }
      return payload.client_secret;
    }

    function waitForChatKit(chatElement, attempts = 20) {
      return new Promise((resolve, reject) => {
        const interval = setInterval(() => {
          if ((chatElement && typeof chatElement.setOptions === "function") ||
            (window.ChatKit && typeof window.ChatKit.mount === "function")) {
            clearInterval(interval);
            resolve();
          } else if (--attempts <= 0) {
            clearInterval(interval);
            reject(new Error("ChatKit script did not load"));
          }
        }, 200);
      });
    }

    async function mountChat() {
      const chatElement = document.getElementById("chatkit-embed");
      if (!chatElement) return;

      try {
        await waitForChatKit(chatElement);
        const api = {
          async getClientSecret(existing) {
            if (existing) return existing;
            return fetchClientSecret();
          },
        };

        if (window.ChatKit?.mount) {
          await window.ChatKit.mount({
            element: chatElement,
            api,
            theme: {
              appearance: "dark",
              color: { brand: "#22d3ee" },
            },
          });
        } else if (typeof chatElement.setOptions === "function") {
          chatElement.setOptions({
            api,
            theme: {
              appearance: "dark",
              color: { brand: "#22d3ee" },
            },
          });
        }

        setStatus("ChatKit is ready. Say hello to your agent!", "ready");
        chatElement.textContent = "";
      } catch (error) {
        console.error(error);
        setStatus(error.message, "error");
      }
    }

    window.addEventListener("load", mountChat);
  </script>
</body>
</html>
